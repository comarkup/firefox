<!DOCTYPE html>
<html>
<head>
    <title>CoMarkup Preview</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fb;
        }
        #root {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 100px;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .error {
            color: #ef4444;
            padding: 10px;
            border: 1px solid #ef4444;
            border-radius: 4px;
            margin: 10px 0;
        }
        .loading {
            padding: 20px;
            text-align: center;
            color: #666;
        }
    </style>
</head>
<body>
<div id="root">
    <div class="loading">Loading framework...</div>
</div>
<div class="controls">
    <button onclick="copyToClipboard()">Copy HTML</button>
    <button onclick="window.close()">Close</button>
</div>

<script>
    let frameworkReady = false;

    // Helper do ładowania skryptów
    function loadScript(src) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    // Funkcja kopiowania do schowka
    function copyToClipboard() {
        const html = document.getElementById('root').innerHTML;
        navigator.clipboard.writeText(html)
            .then(() => alert('Copied to clipboard!'))
            .catch(err => alert('Error copying: ' + err));
    }

    // Nasłuchiwanie na wiadomości od content script
    window.addEventListener('message', async function(event) {
        if (event.data.type === 'RENDER_CODE') {
            const { code, framework, config } = event.data.payload;

            try {
                // Ładowanie skryptów frameworka
                for (const src of config.scripts) {
                    await loadScript(src);
                }

                // Sprawdzenie dostępności frameworka
                const checks = {
                    'react': () => typeof React !== 'undefined' && typeof ReactDOM !== 'undefined',
                    'vue': () => typeof Vue !== 'undefined',
                    'vanilla': () => true
                };

                if (!checks[framework]()) {
                    throw new Error('Framework not loaded properly');
                }

                // Przygotowanie i wykonanie kodu
                let codeToExecute = '';

                switch (framework) {
                    case 'react':
                        codeToExecute = `
                                const App = () => {
                                    try {
                                        ${code}
                                    } catch (error) {
                                        return React.createElement('div',
                                            { style: { color: 'red' } },
                                            'Error: ' + error.message
                                        );
                                    }
                                };
                                ReactDOM.render(React.createElement(App), document.getElementById('root'));
                            `;
                        break;
                    case 'vue':
                        codeToExecute = `
                                const app = Vue.createApp({
                                    setup() {
                                        return () => {
                                            ${code}
                                        }
                                    }
                                });
                                app.mount('#root');
                            `;
                        break;
                    case 'vanilla':
                        codeToExecute = `
                                (function() {
                                    const root = document.getElementById('root');
                                    ${code}
                                })();
                            `;
                        break;
                }

                // Wykonanie kodu
                if (framework === 'react') {
                    const transformed = Babel.transform(codeToExecute, {
                        presets: ['react']
                    }).code;
                    eval(transformed);
                } else {
                    eval(codeToExecute);
                }

                frameworkReady = true;

            } catch (error) {
                document.getElementById('root').innerHTML =
                    `<div class="error">Error: ${error.message}</div>`;
            }
        }
    });
</script>
</body>
</html>
